<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ãƒã‚±ãƒƒãƒˆç®¡ç†ç”»é¢</title>
    <link rel="stylesheet" href="/static/admin.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <!-- èªè¨¼ç”»é¢ -->
    <div id="authContainer" class="auth-container">
        <div class="auth-box">
            <h2>ğŸ” ç®¡ç†è€…èªè¨¼</h2>
            <div class="form-group">
                <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
            </div>
            <button class="btn btn-primary" onclick="authenticate()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>
    </div>

    <!-- ç®¡ç†ç”»é¢ -->
    <div id="adminContainer" class="admin-container">
        <div class="admin-header">
            <h1>ğŸ“‹ ãƒã‚±ãƒƒãƒˆç®¡ç†</h1>
            <div class="header-buttons">
                <button class="btn btn-refresh" onclick="loadAllTickets()">ğŸ”„ æ›´æ–°</button>
                <button class="btn btn-settings" onclick="openSettings()">âš™ï¸ è¨­å®š</button>
            </div>
        </div>

        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-label">ç·ãƒã‚±ãƒƒãƒˆæ•°</div>
                <div class="stat-value" id="totalTickets">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æœ‰åŠ¹</div>
                <div class="stat-value stat-valid" id="validTickets">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ä½¿ç”¨æ¸ˆã¿</div>
                <div class="stat-value stat-used" id="usedTickets">0</div>
            </div>
        </div>

        <div id="ticketList" class="ticket-list">
            <div class="loading-container">
                <span class="loading"></span>
            </div>
        </div>
    </div>

    <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h3>è¨­å®š</h3>
            <div class="form-group">
                <label for="currentPassword">ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="currentPassword">
            </div>
            <div class="form-group">
                <label for="newPassword">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="newPassword">
            </div>
            <button class="btn btn-primary" onclick="changePassword()">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</button>
            <button class="btn btn-secondary" onclick="closeSettings()">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        // èªè¨¼
        async function authenticate() {
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/api/auth/organizer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const data = await response.json();
                if (data.success) {
                    document.getElementById('authContainer').style.display = 'none';
                    document.getElementById('adminContainer').style.display = 'block';
                    loadAllTickets();
                } else {
                    alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
                }
            } catch (error) {
                console.error('èªè¨¼ã‚¨ãƒ©ãƒ¼:', error);
                alert('èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // å…¨ãƒã‚±ãƒƒãƒˆèª­ã¿è¾¼ã¿
        async function loadAllTickets() {
            const ticketList = document.getElementById('ticketList');
            ticketList.innerHTML = '<div class="loading-container"><span class="loading"></span></div>';

            try {
                const response = await fetch('/api/admin/tickets');
                const data = await response.json();

                if (data.success && data.tickets.length > 0) {
                    // çµ±è¨ˆã‚’æ›´æ–°
                    const total = data.tickets.length;
                    const used = data.tickets.filter(t => t.used).length;
                    const valid = total - used;

                    document.getElementById('totalTickets').textContent = total;
                    document.getElementById('validTickets').textContent = valid;
                    document.getElementById('usedTickets').textContent = used;

                    // ãƒã‚±ãƒƒãƒˆãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
                    ticketList.innerHTML = data.tickets.map(ticket => `
                        <div class="ticket-item ${ticket.used ? 'used' : ''}">
                            <div class="ticket-item-info">
                                <div class="ticket-item-user">ğŸ‘¤ ${ticket.username}</div>
                                <div class="ticket-item-date">ğŸ“… ${ticket.date}</div>
                                <div class="ticket-item-id">ID: ${ticket.id.substring(0, 12)}...</div>
                                <div class="ticket-item-created">ä½œæˆ: ${new Date(ticket.created_at).toLocaleString('ja-JP')}</div>
                                ${ticket.used ? `<div class="ticket-item-used">ä½¿ç”¨: ${new Date(ticket.used_at).toLocaleString('ja-JP')}</div>` : ''}
                            </div>
                            <div class="ticket-item-actions">
                                <div class="ticket-item-status ${ticket.used ? 'status-used' : 'status-valid'}">
                                    ${ticket.used ? 'âœ“ ä½¿ç”¨æ¸ˆã¿' : 'â— æœ‰åŠ¹'}
                                </div>
                                <button class="btn-delete" onclick="deleteTicket('${ticket.id}')">ğŸ—‘ï¸ å‰Šé™¤</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    ticketList.innerHTML = '<div class="empty-message">ãƒã‚±ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
                    document.getElementById('totalTickets').textContent = '0';
                    document.getElementById('validTickets').textContent = '0';
                    document.getElementById('usedTickets').textContent = '0';
                }
            } catch (error) {
                console.error('ãƒã‚±ãƒƒãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                ticketList.innerHTML = '<div class="error-message">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        // ãƒã‚±ãƒƒãƒˆå‰Šé™¤
        async function deleteTicket(ticketId) {
            if (!confirm('ã“ã®ãƒã‚±ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/delete-ticket/${ticketId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.success) {
                    await loadAllTickets();
                } else {
                    alert(data.message);
                }
            } catch (error) {
                console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
        }

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
        async function changePassword() {
            const oldPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;

            if (!oldPassword || !newPassword) {
                alert('ä¸¡æ–¹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ old_password: oldPassword, new_password: newPassword })
                });

                const data = await response.json();
                if (data.success) {
                    alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
                    closeSettings();
                } else {
                    alert(data.message);
                }
            } catch (error) {
                console.error('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // Enterã‚­ãƒ¼ã§èªè¨¼
        document.getElementById('password')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') authenticate();
        });
    </script>
</body>

</html>