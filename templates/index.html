<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒã‚±ãƒƒãƒˆã‚µãƒ¼ãƒ“ã‚¹</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container">
        <!-- ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div id="registerForm" class="register-form" style="display: none;">
            <h2>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²</h2>
            <div class="form-group">
                <label for="username">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå</label>
                <input type="text" id="username" placeholder="åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
            </div>
            <button class="btn btn-primary" onclick="register()" style="width: 100%;">ç™»éŒ²</button>
        </div>

        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div id="header" class="header" style="display: none;">
            <div class="username" id="displayUsername"></div>
            <div class="user-id" id="displayUserId"></div>
        </div>

        <!-- ãƒã‚±ãƒƒãƒˆä¸€è¦§ -->
        <div id="ticketsContainer" class="tickets-container" style="display: none;">
            <div id="ticketsList"></div>
        </div>

        <!-- è³¼å…¥ãƒœã‚¿ãƒ³ -->
        <button id="purchaseBtn" class="purchase-btn" onclick="purchaseTicket()" style="display: none;">
            ãƒã‚±ãƒƒãƒˆã‚’è³¼å…¥
        </button>
    </div>

    <!-- å…¨ç”»é¢QRè¡¨ç¤º -->
    <div id="fullscreenQr" class="fullscreen-qr">
        <button class="close-btn" onclick="closeFullscreen()">Ã—</button>
        <div id="fullscreenQrContainer" style="display: flex; justify-content: center; align-items: center;"></div>
    </div>

    <!-- äºˆç´„ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="reservationModal" class="modal">
        <div class="modal-content">
            <h3>ãƒã‚±ãƒƒãƒˆäºˆç´„</h3>
            <div class="form-group">
                <label for="reservationDate">åˆ©ç”¨æ—¥ã‚’é¸æŠ</label>
                <input type="date" id="reservationDate" class="date-input">
            </div>
            <button class="btn btn-primary" onclick="confirmPurchase()">è³¼å…¥ã™ã‚‹</button>
            <button class="btn btn-secondary" onclick="closeReservationModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script>
        let currentUser = null;

        // QRCodeãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ç¢ºèª
        window.addEventListener('DOMContentLoaded', () => {
            console.log('QRCode library loaded:', typeof QRCode !== 'undefined');
        });

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
        window.addEventListener('DOMContentLoaded', () => {
            const savedUser = localStorage.getItem('ticketUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showUserPage();
            } else {
                document.getElementById('registerForm').style.display = 'block';
            }
        });

        // ç™»éŒ²
        async function register() {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                alert('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });

                const data = await response.json();
                if (data.success) {
                    currentUser = {
                        id: data.user_id,
                        username: data.username
                    };
                    localStorage.setItem('ticketUser', JSON.stringify(currentUser));
                    document.getElementById('registerForm').style.display = 'none';
                    showUserPage();
                }
            } catch (error) {
                console.error('ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
                alert('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒšãƒ¼ã‚¸è¡¨ç¤º
        async function showUserPage() {
            document.getElementById('header').style.display = 'block';
            document.getElementById('ticketsContainer').style.display = 'block';
            document.getElementById('purchaseBtn').style.display = 'block';

            document.getElementById('displayUsername').textContent = currentUser.username;
            document.getElementById('displayUserId').textContent = `ID: ${currentUser.id.substring(0, 8)}...`;

            await loadTickets();
        }

        // ãƒã‚±ãƒƒãƒˆèª­ã¿è¾¼ã¿
        async function loadTickets() {
            try {
                const response = await fetch(`/api/tickets/${currentUser.id}`);
                const data = await response.json();

                const ticketsList = document.getElementById('ticketsList');

                if (data.tickets.length === 0) {
                    ticketsList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ«</div>
                            <div class="empty-state-text">ãƒã‚±ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>
                        </div>
                    `;
                } else {
                    ticketsList.innerHTML = data.tickets.map(ticket => `
                        <div class="ticket-card" onclick="showFullscreenQr('${ticket.id}', '${ticket.date}')">
                            <div class="qr-container">
                                <div id="qr-${ticket.id}" style="display: flex; justify-content: center;"></div>
                            </div>
                            <div class="ticket-info">
                                <div class="ticket-date">${ticket.date}</div>
                                <div>ã‚¿ãƒƒãƒ—ã§æ‹¡å¤§è¡¨ç¤º</div>
                            </div>
                        </div>
                    `).join('');

                    // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ - DOMãŒç¢ºå®Ÿã«å­˜åœ¨ã—ã¦ã‹ã‚‰å®Ÿè¡Œ
                    setTimeout(() => {
                        data.tickets.forEach(ticket => {
                            try {
                                const qrData = JSON.stringify({
                                    id: ticket.id,
                                    date: ticket.date
                                });
                                const container = document.getElementById(`qr-${ticket.id}`);

                                console.log('Generating QR for ticket:', ticket.id);
                                console.log('Container found:', !!container);
                                console.log('QRCode available:', typeof QRCode);

                                if (container) {
                                    // æ—¢å­˜ã®å†…å®¹ã‚’ã‚¯ãƒªã‚¢
                                    container.innerHTML = '';

                                    // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
                                    new QRCode(container, {
                                        text: qrData,
                                        width: 200,
                                        height: 200,
                                        colorDark: "#000000",
                                        colorLight: "#ffffff",
                                        correctLevel: QRCode.CorrectLevel.M
                                    });

                                    console.log('QR code generated successfully for:', ticket.id);
                                } else {
                                    console.error('Container not found for ticket:', ticket.id);
                                }
                            } catch (error) {
                                console.error('QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error, 'Ticket:', ticket.id);
                            }
                        });
                    }, 200);
                }
            } catch (error) {
                console.error('ãƒã‚±ãƒƒãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒã‚±ãƒƒãƒˆè³¼å…¥(ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º)
        function purchaseTicket() {
            const modal = document.getElementById('reservationModal');
            const dateInput = document.getElementById('reservationDate');

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä»Šæ—¥ã®æ—¥ä»˜ã‚’è¨­å®š
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
            dateInput.min = today; // éå»ã®æ—¥ä»˜ã¯é¸æŠä¸å¯

            modal.classList.add('active');
        }

        // äºˆç´„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeReservationModal() {
            document.getElementById('reservationModal').classList.remove('active');
        }

        // è³¼å…¥ç¢ºå®š
        async function confirmPurchase() {
            const selectedDate = document.getElementById('reservationDate').value;

            if (!selectedDate) {
                alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const btn = event.target;
            const originalText = btn.textContent;
            btn.innerHTML = '<span class="loading"></span>';
            btn.disabled = true;

            try {
                const response = await fetch('/api/purchase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        username: currentUser.username,
                        date: selectedDate
                    })
                });

                const data = await response.json();
                if (data.success) {
                    closeReservationModal();
                    await loadTickets();

                    // è³¼å…¥æˆåŠŸã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                    showPurchaseEffect();
                }
            } catch (error) {
                console.error('è³¼å…¥ã‚¨ãƒ©ãƒ¼:', error);
                alert('è³¼å…¥ã«å¤±æ•—ã—ã¾ã—ãŸ');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // è³¼å…¥æˆåŠŸã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        function showPurchaseEffect() {
            const ticketsList = document.getElementById('ticketsList');
            const cards = ticketsList.querySelectorAll('.ticket-card');
            if (cards.length > 0) {
                const lastCard = cards[cards.length - 1];
                lastCard.style.animation = 'none';
                setTimeout(() => {
                    lastCard.style.animation = 'ticketAppear 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                }, 10);
            }
        }

        // å…¨ç”»é¢QRè¡¨ç¤º
        function showFullscreenQr(ticketId, date) {
            try {
                const qrData = JSON.stringify({ id: ticketId, date: date });
                const container = document.getElementById('fullscreenQrContainer');

                console.log('Showing fullscreen QR for:', ticketId);

                // æ—¢å­˜ã®å†…å®¹ã‚’ã‚¯ãƒªã‚¢
                container.innerHTML = '';

                // QRã‚³ãƒ¼ãƒ‰ã‚µã‚¤ã‚ºã‚’è¨ˆç®—
                const qrSize = Math.min(window.innerWidth, window.innerHeight) * 0.8;

                // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
                new QRCode(container, {
                    text: qrData,
                    width: qrSize,
                    height: qrSize,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.M
                });

                // å…¨ç”»é¢è¡¨ç¤º
                document.getElementById('fullscreenQr').classList.add('active');
                console.log('Fullscreen QR displayed');
            } catch (error) {
                console.error('å…¨ç”»é¢QRè¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                alert('QRã‚³ãƒ¼ãƒ‰ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // å…¨ç”»é¢QRé–‰ã˜ã‚‹
        function closeFullscreen() {
            document.getElementById('fullscreenQr').classList.remove('active');
        }
    </script>
</body>

</html>